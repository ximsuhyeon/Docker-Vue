name: Deploy to Elastic Beanstalk (Auto-detect Dockerrun)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: eb-autodetect-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set unique version label & zip name
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA:0:7}"
          VERSION_LABEL="frontend-${SHORT_SHA}-${{ github.run_attempt }}"
          ZIP_FILE="${VERSION_LABEL}.zip"
          echo "VERSION_LABEL=$VERSION_LABEL" >> "$GITHUB_ENV"
          echo "ZIP_FILE=$ZIP_FILE" >> "$GITHUB_ENV"
          echo "VERSION_LABEL=$VERSION_LABEL"
          echo "ZIP_FILE=$ZIP_FILE"

      - name: Locate Dockerrun.aws.json (auto-detect)
        run: |
          set -euo pipefail
          echo "=== repo root ==="
          ls -la

          echo "=== searching Dockerrun.aws.json ==="
          # 가장 먼저 발견된 Dockerrun.aws.json 1개를 사용
          DOCKERRUN_PATH="$(find . -type f -name 'Dockerrun.aws.json' -print | head -n 1)"

          if [ -z "${DOCKERRUN_PATH}" ]; then
            echo "Dockerrun.aws.json not found anywhere in this repo."
            echo "Hint: make sure the file name is exactly Dockerrun.aws.json"
            exit 1
          fi

          # ./ 제거해서 다루기 쉽게 정리
          DOCKERRUN_PATH="${DOCKERRUN_PATH#./}"
          DOCKERRUN_DIR="$(dirname "$DOCKERRUN_PATH")"

          echo "Found: $DOCKERRUN_PATH"
          echo "DOCKERRUN_PATH=$DOCKERRUN_PATH" >> "$GITHUB_ENV"
          echo "DOCKERRUN_DIR=$DOCKERRUN_DIR" >> "$GITHUB_ENV"

          echo "=== Dockerrun dir listing ==="
          ls -la "$DOCKERRUN_DIR"

      - name: Create EB bundle zip (Dockerrun at zip root)
        run: |
          set -euo pipefail
          rm -f "$ZIP_FILE"

          # zip은 "루트에 Dockerrun.aws.json"이 있어야 EB가 안정적으로 인식
          # 그래서 파일을 루트명으로 넣기 위해 -j 옵션(경로 제거)을 사용
          zip -j "$ZIP_FILE" "$DOCKERRUN_PATH"

          # Dockerrun이 같은 폴더의 파일들을 참조할 수 있어서,
          # 흔히 같이 쓰는 파일들은 있으면 자동으로 추가
          # (없어도 에러 안 나게 처리)
          for f in nginx.conf Dockerfile Dockerfile.frontend docker-compose.yml Procfile; do
            if [ -f "$DOCKERRUN_DIR/$f" ]; then
              zip -j "$ZIP_FILE" "$DOCKERRUN_DIR/$f"
            fi
          done

          # .ebextensions 폴더는 경로 유지가 필요해서 -r로 추가 (있으면)
          if [ -d "$DOCKERRUN_DIR/.ebextensions" ]; then
            (cd "$DOCKERRUN_DIR" && zip -r "../$ZIP_FILE" ".ebextensions")
          fi

          echo "=== bundle contents ==="
          unzip -l "$ZIP_FILE" | head -n 200

      - name: Upload bundle to S3
        run: |
          set -euo pipefail
          aws s3 cp "$ZIP_FILE" "s3://${{ secrets.EB_S3_BUCKET }}/$ZIP_FILE"
          echo "Uploaded: s3://${{ secrets.EB_S3_BUCKET }}/$ZIP_FILE"

      - name: Create EB application version (unique label)
        run: |
          set -euo pipefail
          aws elasticbeanstalk create-application-version \
            --application-name "${{ secrets.EB_APPLICATION_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="${{ secrets.EB_S3_BUCKET }}",S3Key="$ZIP_FILE"

      - name: Update EB environment
        run: |
          set -euo pipefail
          aws elasticbeanstalk update-environment \
            --environment-name "${{ secrets.EB_FRONTEND_ENVIRONMENT_NAME }}" \
            --version-label "$VERSION_LABEL"

      - name: Done
        run: |
          echo "Deployed!"
          echo "Environment: ${{ secrets.EB_FRONTEND_ENVIRONMENT_NAME }}"
          echo "Version: $VERSION_LABEL"
